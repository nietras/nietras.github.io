---
layout: post
title: Sep 0.6.0 - CSV Trim Support, .NET 9 and New Benchmarks incl. Apple M1
---

It's been a while since the last update on Sep, but recently 0.6.0 was released
with the following notable changes:

* 🐛 Bug fix to `SepWriter` for selecting multiple columns by indices
* ✂️ `SepReader` Trim Support
* 🤖 .NET 9 Ready
* 🚀 New Benchmarks incl. Apple M1

See [v0.6.0 release](https://github.com/nietras/Sep/releases/tag/v0.6.0) for all
changes and [Sep README on GitHub](https://github.com/nietras/Sep) for full
details. Below I'll go over the notable changes briefly. Keep reading for perf
numbers!

## Bug fix to SepWriter

Yet another reminder that great code coverage (Sep has ~100% now) does not
preclude any bugs... a functioning brain should. However, sometimes a usually
reasonbly well functioning brain has a day off and it that case wrote a test
wrong which meant a bug snuck into `SepWriter.Row` when selecting multiple
columns by indices e.g. for:

```csharp
var cols = row[3, 2];
```

one would expect columns at indices 3 and 2 to be selected, but instead indices
0 and 1 were selected. A simple mistake fixed by using `colIndices[i]` instead
of just `i`. I would guess no one have actually used this, or hope, at least no
such usage at work.

## Trim Support

Sep supports trimming by the
[`SepTrim`](https://github.com/nietras/Sep/tree/main/src/Sep/SepTrim.cs) flags
enum, which has two options as documented there. `To enable trimming set the
option like below:

```csharp
using var reader = Sep.Reader(o => 
    o with { Trim = SepTrim.All }).FromText(text);
```

Below the result of both trimming and unescaping is shown in comparison to
[CsvHelper](https://joshclose.github.io/CsvHelper/). Note unescaping is enabled
for all results shown. It is possible to trim without unescaping too, of course.

As can be seen Sep supports a simple principle of trimming *before* and *after*
unescaping with trimming before unescaping being important for unescaping if
there is a starting quote after spaces.

| Input | CsvHelper Trim | CsvHelper InsideQuotes | CsvHelper All¹ | Sep Outer | Sep AfterUnescape | Sep All² |
|-|-|-|-|-|-|-|
| `a` | `a` | `a` | `a` | `a` | `a` | `a` |
| `·a` | `a` | `·a` | `a` | `a` | `a` | `a` |
| `a·` | `a` | `a·` | `a` | `a` | `a` | `a` |
| `·a·` | `a` | `·a·` | `a` | `a` | `a` | `a` |
| `·a·a·` | `a·a` | `·a·a·` | `a·a` | `a·a` | `a·a` | `a·a` |
| `"a"` | `a` | `a` | `a` | `a` | `a` | `a` |
| `"·a"` | `·a` | `a` | `a` | `·a` | `a` | `a` |
| `"a·"` | `a·` | `a` | `a` | `a·` | `a` | `a` |
| `"·a·"` | `·a·` | `a` | `a` | `·a·` | `a` | `a` |
| `"·a·a·"` | `·a·a·` | `a·a` | `a·a` | `·a·a·` | `a·a` | `a·a` |
| `·"a"·` | `a` | `·"a"·` | `a` | `a` | `"a"` | `a` |
| `·"·a"·` | `·a` | `·"·a"·` | `a` | `·a` | `"·a"` | `a` |
| `·"a·"·` | `a·` | `·"a·"·` | `a` | `a·` | `"a·"` | `a` |
| `·"·a·"·` | `·a·` | `·"·a·"·` | `a` | `·a·` | `"·a·"` | `a` |
| `·"·a·a·"·` | `·a·a·` | `·"·a·a·"·` | `a·a` | `·a·a·` | `"·a·a·"` | `a·a` |

`·` (middle dot) is whitespace to make this visible

¹ CsvHelper with `TrimOptions.Trim | TrimOptions.InsideQuotes`

² Sep with `SepTrim.All = SepTrim.Outer | SepTrim.AfterUnescape` in
`SepReaderOptions`

Trimming has a cost, of course, benchmarks below show this for `AMD Ryzen 9
5950X` when accessing the column `Span` for the package assets benchmark where
most (but not all) columns have been prefixed and suffixed with `·"·`, which
then needs to be removed. For details in benchmarks see Sep on GitHub. As the
numbers show Sep is about 11.20 / 1.44 = 7.78x to 11.07 / 1.69 = 6.54x faster
than CsvHelper for this scenario. Sylvan does not appear to support trimming.

```
| Method                     | Scope | Rows  | Mean      | Ratio | MB | MB/s   | ns/row | Allocated | Alloc Ratio |
|--------------------------- |------ |------ |----------:|------:|---:|-------:|-------:|----------:|------------:|
| Sep_                       | Cols  | 50000 |  8.599 ms |  1.00 | 41 | 4857.5 |  172.0 |   1.04 KB |        1.00 |
| Sep_Trim                   | Cols  | 50000 | 12.402 ms |  1.44 | 41 | 3368.0 |  248.0 |   1.05 KB |        1.01 |
| Sep_TrimUnescape           | Cols  | 50000 | 13.201 ms |  1.54 | 41 | 3164.1 |  264.0 |   1.06 KB |        1.02 |
| Sep_TrimUnescapeTrim       | Cols  | 50000 | 14.568 ms |  1.69 | 41 | 2867.3 |  291.4 |   1.07 KB |        1.02 |
| CsvHelper_TrimUnescape     | Cols  | 50000 | 96.272 ms | 11.20 | 41 |  433.9 | 1925.4 | 451.52 KB |      432.51 |
| CsvHelper_TrimUnescapeTrim | Cols  | 50000 | 95.183 ms | 11.07 | 41 |  438.8 | 1903.7 | 445.86 KB |      427.09 |
```

## .NET 9 Ready

Sep 0.6.0 is fully compatible with .NET 9, taking advantage of the latest
features and performance improvements. This ensures that Sep remains at the
cutting edge of .NET development, providing the best possible performance for
your CSV parsing needs.

## New Benchmarks

In addition to the trimming benchmarks, we have also conducted new benchmarks on
the Apple M1 platform, focusing on the floats parsing scenario. This scenario is
particularly relevant for machine learning applications, where parsing large
amounts of floating-point data efficiently is crucial.

### Apple M1 - Floats Benchmark Results

| Method       | Scope  | Rows    | Mean         | Ratio | MB  | MB/s   | ns/row | Allocated    | Alloc Ratio |
|--------------|--------|---------|--------------|-------|-----|--------|--------|--------------|-------------|
| Sep______    | Row    | 100000  | 36.55 ms     | 1.00  | 109 | 2982.5 | 365.5  | 1.51 KB      | 1.00        |
| Sylvan___    | Row    | 100000  | 98.62 ms     | 2.70  | 109 | 1105.4 | 986.2  | 138.18 KB    | 91.76       |
| CsvHelper    | Row    | 100000  | 225.93 ms    | 6.25  | 109 | 482.5  | 2259.3 | 20.61 KB     | 13.69       |

As shown in the benchmarks, Sep continues to outperform other CSV parsers, providing unparalleled performance on the Apple M1 platform.

## Conclusion

Sep 0.6.0 brings significant improvements with the addition of trim support, .NET 9 compatibility, and new benchmarks demonstrating its performance on the Apple M1. These updates ensure that Sep remains the fastest and most efficient .NET CSV parser available.

For more details on the API and usage, please refer to the [README](https://github.com/nietras/Sep) on GitHub. If you haven't already, please consider starring the project on GitHub to show your support.